<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIN Tracker Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            background-attachment: fixed;
            color: #f1f5f9;
            line-height: 1.5;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
        }

        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(circle at center, rgba(99,102,241,0.2) 0%, transparent 70%);
        }
        
        .glass-card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            max-width: 500px;
            width: 90%;
            padding: 40px;
            margin: 20px;
        }

        .login-header { text-align: center; margin-bottom: 32px; }
        
        .logo {
            width: 380px;
            height: 220px;
            margin: 0 auto 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 12px;
            background: transparent;
        }
        
        .logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        @media (max-width: 640px) {
            .glass-card {
                padding: 24px 16px;
                margin: 10px;
                width: 95%;
            }
            
            .logo {
                width: 100%;
                max-width: 280px;
                height: 160px;
                margin-bottom: 16px;
            }
            
            .login-header h2 {
                font-size: 20px;
            }
        }

        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #94a3b8; font-size: 14px; font-weight: 500; }
        .modern-input {
            width: 100%; padding: 12px 16px;
            background: rgba(15,23,42,0.6);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; color: white; font-size: 15px;
        }
        .modern-input:focus { outline: none; border-color: #6366f1; }

        .online-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #34d399;
            font-size: 12px;
            margin-bottom: 16px;
            background: rgba(16,185,129,0.15);
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid rgba(16,185,129,0.3);
        }
        
        .online-status::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #34d399;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .online-status.offline {
            color: #f87171;
            background: rgba(239,68,68,0.15);
            border-color: rgba(239,68,68,0.3);
        }
        
        .online-status.offline::before {
            background: #f87171;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn {
            padding: 12px 24px; border: none; border-radius: 10px;
            font-size: 14px; font-weight: 600; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white; width: 100%; justify-content: center;
            box-shadow: 0 4px 15px rgba(99,102,241,0.4);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99,102,241,0.6); }
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .error-message { color: #ef4444; margin-top: 12px; text-align: center; font-size: 14px; }
        .success-message { color: #34d399; margin-top: 12px; text-align: center; font-size: 14px; }

        .app-container { max-width: 1400px; margin: 0 auto; padding: 24px; display: none; }
        
        @media (max-width: 640px) {
            .app-container {
                padding: 12px;
            }
        }
        
        .modern-header {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(30,41,59,0.8);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; padding: 16px 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .modern-header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
                padding: 12px;
            }
            
            .header-left {
                justify-content: center;
            }
            
            .brand-text {
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }
            
            .header-separator {
                display: none;
            }
        }
        
        .header-left { display: flex; align-items: center; gap: 16px; }
        .brand-logo {
            width: 48px; height: 48px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: white;
            box-shadow: 0 0 20px rgba(99,102,241,0.4);
        }
        
        .brand-text { display: flex; align-items: baseline; gap: 12px; flex-wrap: wrap; }
        .brand-text h1 { font-size: 24px; font-weight: 800; display: flex; align-items: center; gap: 8px; color: white; }
        .pro-badge {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            padding: 4px 10px; border-radius: 20px;
            font-size: 11px; font-weight: 700; color: white;
        }
        .header-separator { color: #475569; font-size: 20px; }
        .header-subtitle { color: #94a3b8; font-size: 14px; font-weight: 500; }

        .session-info {
            display: flex; align-items: center; gap: 12px;
            background: rgba(255,255,255,0.05);
            padding: 8px 16px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .avatar-icon { font-size: 28px; color: #6366f1; }
        .user-text { display: flex; flex-direction: column; line-height: 1.3; }
        .user-name { font-weight: 600; font-size: 14px; color: white; }
        .role-tag { font-size: 11px; color: #94a3b8; text-transform: uppercase; }
        
        .btn-logout {
            width: 36px; height: 36px; border-radius: 10px;
            border: none; background: rgba(239,68,68,0.2);
            color: #f87171; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .btn-logout:hover { background: #ef4444; color: white; }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        @media (max-width: 1024px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
        
        @media (max-width: 640px) {
            .stats-row { 
                grid-template-columns: repeat(2, 1fr); 
                gap: 10px;
            }
            
            .stat-card {
                padding: 12px;
                gap: 12px;
            }
            
            .stat-icon-box {
                width: 44px;
                height: 44px;
                font-size: 20px;
                border-radius: 12px;
            }
            
            .stat-number {
                font-size: 22px;
            }
            
            .stat-label {
                font-size: 12px;
            }
        }

        .stat-card {
            background: rgba(30,41,59,0.8);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .stat-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .stat-icon-box {
            width: 60px; height: 60px; border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; flex-shrink: 0;
        }
        
        .stat-pending .stat-icon-box {
            background: linear-gradient(135deg, rgba(239,68,68,0.3) 0%, rgba(239,68,68,0.1) 100%);
            color: #f87171;
            box-shadow: 0 0 30px rgba(239,68,68,0.4);
            border: 1px solid rgba(239,68,68,0.3);
        }
        .stat-inspected .stat-icon-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.3) 0%, rgba(16,185,129,0.1) 100%);
            color: #34d399;
            box-shadow: 0 0 30px rgba(16,185,129,0.4);
            border: 1px solid rgba(16,185,129,0.3);
        }
        .stat-notfound .stat-icon-box {
            background: linear-gradient(135deg, rgba(245,158,11,0.3) 0%, rgba(245,158,11,0.1) 100%);
            color: #fbbf24;
            box-shadow: 0 0 30px rgba(245,158,11,0.4);
            border: 1px solid rgba(245,158,11,0.3);
        }
        .stat-total .stat-icon-box {
            background: linear-gradient(135deg, rgba(99,102,241,0.3) 0%, rgba(99,102,241,0.1) 100%);
            color: #a5b4fc;
            box-shadow: 0 0 30px rgba(99,102,241,0.4);
            border: 1px solid rgba(99,102,241,0.3);
        }

        .stat-info { display: flex; flex-direction: column; }
        .stat-number { font-size: 32px; font-weight: 800; line-height: 1; color: white; }
        .stat-label { font-size: 14px; color: #94a3b8; margin-top: 4px; font-weight: 500; }

        .input-panel {
            background: linear-gradient(135deg, rgba(99,102,241,0.1) 0%, rgba(139,92,246,0.05) 100%);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; padding: 24px; margin-bottom: 24px;
        }
        
        @media (max-width: 640px) {
            .input-panel {
                padding: 16px;
            }
            
            textarea {
                min-height: 80px;
                padding: 12px;
                font-size: 16px;
            }
            
            .input-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .panel-header h3 { font-size: 18px; color: white; display: flex; align-items: center; gap: 10px; }
        .badge-manager {
            background: rgba(99,102,241,0.2); color: #a5b4fc;
            padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
        }
        .panel-desc { color: #94a3b8; margin-bottom: 16px; font-size: 14px; }
        
        @media (max-width: 640px) {
            .panel-header h3 {
                font-size: 16px;
            }
            
            .badge-manager {
                font-size: 10px;
                padding: 2px 8px;
            }
        }
        
        textarea {
            width: 100%; min-height: 100px; padding: 16px;
            background: rgba(15,23,42,0.5);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 10px; color: white;
            font-family: 'Courier New', monospace; font-size: 14px;
            margin-bottom: 16px; resize: vertical;
        }
        textarea:focus { outline: none; border-color: #6366f1; }

        .input-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-danger { background: rgba(239,68,68,0.2); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }
        .btn-success { background: rgba(16,185,129,0.2); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
        .btn-accent { background: rgba(139,92,246,0.2); color: #c4b5fd; border: 1px solid rgba(139,92,246,0.3); }

        .alert-box {
            display: flex; align-items: center; gap: 16px;
            background: rgba(59,130,246,0.1);
            border: 1px solid rgba(59,130,246,0.2);
            border-radius: 12px; padding: 20px; margin-bottom: 24px;
        }
        
        @media (max-width: 640px) {
            .alert-box {
                flex-direction: column;
                text-align: center;
                padding: 16px;
                gap: 12px;
            }
            
            .alert-box i {
                font-size: 32px;
            }
        }
        
        .alert-box i { font-size: 24px; color: #60a5fa; }
        .alert-box strong { color: white; }

        .toolbar {
            display: flex; justify-content: space-between; align-items: center;
            gap: 16px; margin-bottom: 20px; flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: 100%;
                min-width: auto;
            }
            
            .action-buttons {
                justify-content: center;
                width: 100%;
            }
        }
        
        .search-box {
            position: relative; flex: 1; max-width: 400px; min-width: 280px;
        }
        .search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: #94a3b8; font-size: 16px;
        }
        .search-input {
            width: 100%; padding: 12px 40px 12px 42px;
            background: rgba(30,41,59,0.8);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 12px; color: white; font-size: 15px;
        }
        .search-input:focus { outline: none; border-color: #6366f1; }
        .search-clear {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.1); border: none; color: #94a3b8;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .search-results { color: #94a3b8; font-size: 14px; margin-left: 12px; }
        .action-buttons { display: flex; gap: 10px; }

        .table-wrap {
            background: rgba(30,41,59,0.8);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px; 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .table-wrap::after {
            content: '← Desliza →';
            position: absolute;
            bottom: 5px;
            right: 10px;
            font-size: 10px;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
            display: none;
        }
        
        @media (max-width: 768px) {
            .table-wrap::after {
                display: block;
            }
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 14px;
            min-width: 950px;
        }
        
        @media (max-width: 640px) {
            table {
                min-width: 850px;
                font-size: 13px;
            }
            
            th, td {
                padding: 10px 8px !important;
            }
            
            td:nth-child(3) input {
                font-size: 12px !important;
                min-width: 100px;
            }
        }
        
        thead { background: rgba(99,102,241,0.1); }
        th {
            padding: 14px 16px; text-align: left; font-weight: 600;
            color: #a5b4fc; font-size: 12px; text-transform: uppercase;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }
        td { 
            padding: 12px 16px; 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
            color: #f1f5f9; 
            white-space: nowrap;
        }
        tr:hover { background: rgba(255,255,255,0.03); }
        tr.status-pending { background: rgba(239,68,68,0.08); }
        tr.status-inspected { background: rgba(16,185,129,0.08); }
        tr.status-not-found { background: rgba(245,158,11,0.08); }
        
        .input-cell {
            width: 100%; background: transparent; border: 1px solid transparent;
            padding: 8px; color: white; border-radius: 6px; font-family: inherit;
            font-size: 14px;
            min-width: 80px;
        }
        .input-cell:focus { outline: none; background: rgba(255,255,255,0.1); border-color: #6366f1; }
        
        @media (max-width: 640px) {
            .input-cell {
                font-size: 13px;
                padding: 6px 4px;
                min-width: 60px;
            }
            
            td:nth-child(1) { width: 30px; }
            td:nth-child(4) { width: 100px; }
            td:nth-child(5) { width: 110px; }
        }
        
        select.input-cell {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23f1f5f9' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 28px;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer; font-weight: 600;
        }

        select.input-cell option {
            background-color: #0f172a !important;
            color: #f1f5f9 !important;
            padding: 12px; font-size: 14px; font-weight: 500;
        }
        select.input-cell option[value="Pending"] {
            background-color: #450a0a !important;
            color: #fca5a5 !important;
        }
        select.input-cell option[value="Inspected"] {
            background-color: #064e3b !important;
            color: #6ee7b7 !important;
        }
        select.input-cell option[value="Not Found"] {
            background-color: #451a03 !important;
            color: #fcd34d !important;
        }

        .empty-state { text-align: center; padding: 60px; color: #64748b; }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }

        @media (max-width: 640px) {
            .empty-state {
                padding: 40px 20px;
            }
            
            .empty-state i {
                font-size: 36px;
            }
        }

        .footer-bar {
            text-align: center; margin-top: 20px; color: #64748b;
            font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 8px;
            padding: 0 10px;
        }

        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            overflow-y: auto; padding: 20px;
        }
        .report-box {
            max-width: 1000px; margin: 40px auto; padding: 32px;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .report-box {
                margin: 10px auto;
                padding: 20px 16px;
                max-width: 95%;
            }
            
            .modal {
                padding: 10px;
            }
            
            .report-content {
                grid-template-columns: 1fr !important;
            }
            
            .chart-wrap {
                height: 300px;
                padding: 10px;
            }
        }
        
        .close-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255,255,255,0.1); border: none; color: #94a3b8;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px;
        }
        .close-btn:hover { background: rgba(255,255,255,0.2); color: white; transform: rotate(90deg); }
        .modal-title { margin-bottom: 24px; color: white; font-size: 24px; }
        .report-content { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        
        .chart-wrap { height: 400px; display: flex; align-items: center; justify-content: center; }
        .modal-footer { margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .debug-info {
            background: rgba(239,68,68,0.1);
            border: 1px solid rgba(239,68,68,0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            font-size: 12px;
            color: #fca5a5;
            display: none;
        }

        .auth-debug {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-size: 11px;
            font-family: monospace;
            z-index: 9999;
            max-width: 300px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginModal" class="modal login-screen" style="display: flex;">
        <div class="glass-card">
            <div class="login-header">
                <div class="logo">
                    <img src="100-year-Celebration-caterpillar.jpg" alt="Caterpillar 100 Years">
                </div>
                <h2>VIN Tracker Pro</h2>
                <p style="color: #94a3b8;">Secure Access Required</p>
            </div>
            
            <div class="login-form">
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" class="modern-input" placeholder="manager@cat.com">
                </div>
                
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" class="modern-input" placeholder="••••••••">
                </div>
                
                <button onclick="auth.login()" class="btn btn-primary" id="loginBtn">
                    <span class="spinner" id="loginSpinner"></span>
                    <span id="loginBtnText"><i class="fas fa-sign-in-alt"></i> Access System</span>
                </button>
                
                <div id="loginError" class="error-message"></div>
                <div id="loginSuccess" class="success-message"></div>
                
                <div id="debugInfo" class="debug-info"></div>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="mainContainer">
        <div style="text-align: center; margin-bottom: 16px;">
            <div class="online-status" id="connectionStatus">
                <i class="fas fa-circle" style="font-size: 8px; margin-right: 4px;"></i> Connecting...
            </div>
        </div>

        <header class="modern-header">
            <div class="header-left">
                <div class="brand-logo">
                    <i class="fas fa-search-dollar"></i>
                </div>
                <div class="brand-text">
                    <h1>VIN Tracker <span class="pro-badge">PRO</span></h1>
                    <span class="header-separator">•</span>
                    <span class="header-subtitle">Live Status Monitoring System</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="session-info">
                    <div class="avatar-icon">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="user-text">
                        <span id="currentUser" class="user-name">user@cat.com</span>
                        <span id="userRole" class="role-tag">manager</span>
                    </div>
                    <button onclick="auth.logout()" class="btn-logout" title="Logout">
                        <i class="fas fa-power-off"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="stats-row">
            <div class="stat-card stat-pending">
                <div class="stat-icon-box">
                    <i class="fas fa-hourglass-half"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-number" id="statPending">0</span>
                    <span class="stat-label">Pending</span>
                </div>
            </div>

            <div class="stat-card stat-inspected">
                <div class="stat-icon-box">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-number" id="statInspected">0</span>
                    <span class="stat-label">Inspected</span>
                </div>
            </div>

            <div class="stat-card stat-notfound">
                <div class="stat-icon-box">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-number" id="statNotFound">0</span>
                    <span class="stat-label">Not Found</span>
                </div>
            </div>

            <div class="stat-card stat-total">
                <div class="stat-icon-box">
                    <i class="fas fa-database"></i>
                </div>
                <div class="stat-info">
                    <span class="stat-number" id="statTotal">0</span>
                    <span class="stat-label">Total Records</span>
                </div>
            </div>
        </div>

        <div id="inputSection" class="input-panel" style="display: none;">
            <div class="panel-header">
                <h3><i class="fas fa-plus-circle"></i> Batch Entry</h3>
                <span class="badge-manager">Manager Only</span>
            </div>
            <p class="panel-desc">Paste VINs below. System will auto-detect Serial Numbers. Changes sync instantly to all devices.</p>
            
            <textarea id="batchVins" placeholder="CAT00275CR8Y05091
CAT00275CKRY05091
CAT00275CFL12345..."></textarea>
            
            <div class="input-actions">
                <button onclick="app.processBatchVins()" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Entries
                </button>
                <button onclick="app.clearInput()" class="btn btn-secondary">
                    <i class="fas fa-eraser"></i> Clear
                </button>
                <button onclick="app.resetData()" class="btn btn-danger">
                    <i class="fas fa-trash"></i> Reset All
                </button>
            </div>
        </div>

        <div id="techMessage" class="alert-box" style="display: none;">
            <i class="fas fa-info-circle"></i>
            <div>
                <strong>Real-time Sync Mode</strong>
                <p style="color: #94a3b8; font-size: 14px;">Changes you make will be visible instantly to all connected users. You can update Status from "Pending" to "Inspected/Not Found" and add comments.</p>
            </div>
        </div>

        <div class="toolbar">
            <div style="display: flex; align-items: center; flex: 1;">
                <div class="search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="search-input" 
                           placeholder="Search VIN or Serial Number..." 
                           onkeyup="app.handleSearch()">
                    <button onclick="app.clearSearch()" class="search-clear" id="clearSearchBtn" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <span class="search-results" id="searchResults"></span>
            </div>

            <div class="action-buttons">
                <button onclick="app.generateReport()" class="btn btn-accent">
                    <i class="fas fa-chart-pie"></i> Report
                </button>
                <button onclick="app.exportExcel()" class="btn btn-success">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button onclick="app.exportPDF()" class="btn btn-danger">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>
        </div>

        <div class="table-wrap">
            <div style="min-width: 950px;">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th width="40">#</th>
                            <th>VIN</th>
                            <th>Serial Number</th>
                            <th width="110">Date</th>
                            <th width="130">Status</th>
                            <th>Technician</th>
                            <th width="140">Last Update</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-inbox"></i>
                <h3>No records found</h3>
                <p>Try adjusting your search criteria</p>
            </div>
        </div>

        <div class="footer-bar">
            <i class="fas fa-sync-alt"></i> <span id="lastUpdate">Updated: Just now</span>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="glass-card report-box">
            <button class="close-btn" onclick="app.closeReport()">
                <i class="fas fa-times"></i>
            </button>
            
            <h2 class="modal-title"><i class="fas fa-chart-pie"></i> Status Analytics</h2>
            
            <div class="report-content">
                <div id="reportContent" style="max-height: 500px; overflow-y: auto;"></div>
                <div class="chart-wrap">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="app.exportReportPDF()" class="btn btn-danger">
                    <i class="fas fa-download"></i> Download PDF
                </button>
            </div>
        </div>
    </div>

    <!-- DEBUG PANEL (presiona F12 para ver) -->
    <div id="authDebug" class="auth-debug"></div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <!-- FIREBASE SDK - Modular v10+ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, push } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD3uWheIL3CuqF4yAetxLIEt8DMcKY9W98",
            authDomain: "vin-tracker-f0834.firebaseapp.com",
            databaseURL: "https://vin-tracker-f0834-default-rtdb.firebaseio.com",
            projectId: "vin-tracker-f0834",
            storageBucket: "vin-tracker-f0834.firebasestorage.app",
            messagingSenderId: "949409357299",
            appId: "1:949409357299:web:0752144b2db947be1b0686"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const database = getDatabase(firebaseApp);
        const auth = getAuth(firebaseApp);

        // Variable global para la referencia de la base de datos
        let vinsRef = null;

        setPersistence(auth, browserLocalPersistence);

        // Función para actualizar debug panel
        function updateDebug() {
            const debugDiv = document.getElementById('authDebug');
            const user = auth.currentUser;
            debugDiv.innerHTML = `
                <strong>Auth Status:</strong> ${user ? '✅ Authenticated' : '❌ Not authenticated'}<br>
                ${user ? `
                <strong>Email:</strong> ${user.email}<br>
                <strong>UID:</strong> ${user.uid}<br>
                <strong>Anonymous:</strong> ${user.isAnonymous}<br>
                <strong>Email Verified:</strong> ${user.emailVerified}<br>
                ` : 'No user data'}
                <hr style="margin: 5px 0; border-color: #333;">
                <strong>Database Ref:</strong> ${vinsRef ? '✅ Set' : '❌ Not set'}<br>
                <strong>Timestamp:</strong> ${new Date().toLocaleTimeString()}
            `;
            debugDiv.style.display = 'block';
        }

        window.auth = {
            currentUser: null,
            userRole: null,

            userRoles: {
                'manager@cat.com': 'manager',
                'tech@cat.com': 'tech'
            },

            async login() {
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                const errorDiv = document.getElementById('loginError');
                const successDiv = document.getElementById('loginSuccess');
                const debugDiv = document.getElementById('debugInfo');
                const btn = document.getElementById('loginBtn');
                const spinner = document.getElementById('loginSpinner');
                const btnText = document.getElementById('loginBtnText');

                errorDiv.textContent = '';
                successDiv.textContent = '';
                debugDiv.style.display = 'none';

                if (!email || !password) {
                    errorDiv.textContent = 'Please enter email and password';
                    return;
                }

                btn.disabled = true;
                spinner.style.display = 'block';
                btnText.style.display = 'none';

                try {
                    console.log('Attempting login...');
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    console.log('Login successful!');
                    console.log('User:', user.email);
                    console.log('UID:', user.uid);
                    console.log('ID Token available');
                    
                    this.userRole = this.userRoles[email] || 'tech';
                    this.currentUser = email;
                    
                    successDiv.textContent = 'Login successful! Loading...';
                    
                    // Esperar un momento para asegurar que el token esté listo
                    setTimeout(() => {
                        this.showMainInterface();
                    }, 1000);

                } catch (error) {
                    console.error('Login error:', error);
                    let errorMsg = 'Login failed. ';
                    
                    switch(error.code) {
                        case 'auth/invalid-email':
                            errorMsg += 'Invalid email format.';
                            break;
                        case 'auth/user-disabled':
                            errorMsg += 'Account disabled.';
                            break;
                        case 'auth/user-not-found':
                            errorMsg += 'User not found.';
                            break;
                        case 'auth/wrong-password':
                            errorMsg += 'Incorrect password.';
                            break;
                        case 'auth/invalid-credential':
                            errorMsg += 'Invalid credentials.';
                            break;
                        case 'auth/network-request-failed':
                            errorMsg += 'Network error. Check connection.';
                            break;
                        default:
                            errorMsg += error.message;
                    }
                    
                    errorDiv.textContent = errorMsg;
                    
                    debugDiv.innerHTML = `
                        <strong>Error técnico:</strong><br>
                        Code: ${error.code}<br>
                        Message: ${error.message}
                    `;
                    debugDiv.style.display = 'block';
                } finally {
                    btn.disabled = false;
                    spinner.style.display = 'none';
                    btnText.style.display = 'inline-flex';
                }
            },

            async logout() {
                if (confirm('Logout?')) {
                    try {
                        await signOut(auth);
                        vinsRef = null; // Limpiar referencia
                        location.reload();
                    } catch (error) {
                        console.error('Logout error:', error);
                        alert('Error during logout: ' + error.message);
                    }
                }
            },

            showMainInterface() {
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                
                document.getElementById('currentUser').textContent = this.currentUser;
                document.getElementById('userRole').textContent = this.userRole;

                if (this.userRole === 'manager') {
                    document.getElementById('inputSection').style.display = 'block';
                    document.getElementById('techMessage').style.display = 'none';
                } else {
                    document.getElementById('inputSection').style.display = 'none';
                    document.getElementById('techMessage').style.display = 'flex';
                }

                // Inicializar la app después de asegurar autenticación
                app.init();
            },

            init() {
                onAuthStateChanged(auth, (user) => {
                    updateDebug();
                    
                    if (user) {
                        console.log('Auth state: User is signed in', user.email);
                        this.currentUser = user.email;
                        this.userRole = this.userRoles[user.email] || 'tech';
                        this.showMainInterface();
                    } else {
                        console.log('Auth state: No user');
                        document.getElementById('loginModal').style.display = 'flex';
                        document.getElementById('mainContainer').style.display = 'none';
                    }
                });

                document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.login();
                });
                
                // Actualizar debug cada 5 segundos
                setInterval(updateDebug, 5000);
            }
        };

        window.app = {
            data: [],
            filteredData: [],
            chart: null,
            searchTerm: '',

            init() {
                // Crear referencia DESPUÉS de autenticación
                vinsRef = ref(database, 'vins');
                console.log('VinsRef initialized:', vinsRef);
                updateDebug();
                
                this.setupRealtimeListener();
                this.setupConnectionStatus();
            },

            setupConnectionStatus() {
                const statusDiv = document.getElementById('connectionStatus');
                const connectedRef = ref(database, ".info/connected");
                
                onValue(connectedRef, (snap) => {
                    if (snap.val() === true) {
                        statusDiv.innerHTML = '<i class="fas fa-wifi" style="font-size: 10px; margin-right: 4px;"></i> SYNCHRONIZED';
                        statusDiv.classList.remove('offline');
                    } else {
                        statusDiv.innerHTML = '<i class="fas fa-wifi-slash" style="font-size: 10px; margin-right: 4px;"></i> OFFLINE';
                        statusDiv.classList.add('offline');
                    }
                });
            },

            setupRealtimeListener() {
                if (!vinsRef) {
                    console.error('vinsRef is not initialized!');
                    return;
                }
                
                console.log('Setting up realtime listener...');
                
                onValue(vinsRef, (snapshot) => {
                    console.log('Data received from Firebase');
                    const data = snapshot.val();
                    if (data) {
                        this.data = Object.keys(data).map(key => ({
                            firebaseKey: key,
                            ...data[key]
                        }));
                        this.data.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    } else {
                        this.data = [];
                    }
                    this.filteredData = [...this.data];
                    this.updateStats();
                    this.renderTable();
                    
                    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleString();
                }, (error) => {
                    console.error('Error reading data:', error);
                    alert('Error reading data: ' + error.message);
                });
            },

            updateStats() {
                const stats = { Pending: 0, Inspected: 0, 'Not Found': 0, Total: this.data.length };
                this.data.forEach(row => {
                    if (stats[row.status] !== undefined) stats[row.status]++;
                });
                
                document.getElementById('statPending').textContent = stats.Pending;
                document.getElementById('statInspected').textContent = stats.Inspected;
                document.getElementById('statNotFound').textContent = stats['Not Found'];
                document.getElementById('statTotal').textContent = stats.Total;
            },

            handleSearch() {
                const input = document.getElementById('searchInput');
                const term = input.value.trim().toUpperCase();
                const clearBtn = document.getElementById('clearSearchBtn');
                const resultsLabel = document.getElementById('searchResults');
                
                this.searchTerm = term;
                
                if (term) {
                    clearBtn.style.display = 'flex';
                    this.filteredData = this.data.filter(row => 
                        row.vin.toUpperCase().includes(term) || 
                        row.serialNumber.toUpperCase().includes(term)
                    );
                    resultsLabel.textContent = `${this.filteredData.length} found`;
                } else {
                    clearBtn.style.display = 'none';
                    this.filteredData = [...this.data];
                    resultsLabel.textContent = '';
                }
                
                this.renderTable();
            },

            clearSearch() {
                document.getElementById('searchInput').value = '';
                this.searchTerm = '';
                this.filteredData = [...this.data];
                document.getElementById('clearSearchBtn').style.display = 'none';
                document.getElementById('searchResults').textContent = '';
                this.renderTable();
            },

            clearInput() {
                document.getElementById('batchVins').value = '';
                document.getElementById('batchVins').focus();
            },

            async processBatchVins() {
                if (window.auth.userRole !== 'manager') {
                    alert('Only managers can add VINs');
                    return;
                }
                
                // Verificar autenticación antes de proceder
                if (!auth.currentUser) {
                    alert('Error: User not authenticated. Please login again.');
                    return;
                }
                
                const textarea = document.getElementById('batchVins');
                const text = textarea.value.trim();
                
                if (!text) {
                    alert('Enter VINs');
                    return;
                }

                const vins = text.split(/[\n,\s\t]+/)
                    .map(v => v.trim().toUpperCase())
                    .filter(v => v.length > 0);

                if (vins.length === 0) return;

                console.log('Processing VINs:', vins);
                console.log('Current user:', auth.currentUser.email);
                console.log('User UID:', auth.currentUser.uid);

                const updates = {};
                
                vins.forEach(vin => {
                    const serialMatch = vin.match(/(FL|R8|ZE|KR|2X|P9).*$/i);
                    const serialNumber = serialMatch ? serialMatch[0] : '';
                    
                    const newKey = push(vinsRef).key;
                    updates[newKey] = {
                        vin: vin,
                        serialNumber: serialNumber,
                        entryDate: new Date().toISOString().split('T')[0],
                        status: 'Pending',
                        assignedTech: '',
                        lastUpdate: null,
                        comments: '',
                        timestamp: Date.now(),
                        createdBy: auth.currentUser.email,
                        createdByUid: auth.currentUser.uid
                    };
                });

                try {
                    console.log('Sending updates to Firebase...');
                    console.log('VinsRef:', vinsRef);
                    console.log('Updates:', updates);
                    
                    await update(vinsRef, updates);
                    
                    console.log('✅ Updates sent successfully');
                    textarea.value = '';
                    alert(`✅ Added ${vins.length} VINs`);
                } catch (error) {
                    console.error('❌ Error adding VINs:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    let errorMsg = 'Error adding VINs: ' + error.message;
                    
                    if (error.code === 'PERMISSION_DENIED') {
                        errorMsg += '\n\nEl usuario está autenticado pero no tiene permisos.';
                        errorMsg += '\nEmail: ' + (auth.currentUser?.email || 'N/A');
                        errorMsg += '\nUID: ' + (auth.currentUser?.uid || 'N/A');
                        errorMsg += '\n\nVerifica que las reglas de seguridad permitan escritura para usuarios autenticados (auth != null).';
                    }
                    
                    alert(errorMsg);
                }
            },

            renderTable() {
                const tbody = document.getElementById('tableBody');
                const emptyState = document.getElementById('emptyState');
                const dataToShow = this.searchTerm ? this.filteredData : this.data;
                
                tbody.innerHTML = '';

                if (dataToShow.length === 0) {
                    emptyState.style.display = 'block';
                    tbody.style.display = 'none';
                    return;
                }
                
                emptyState.style.display = 'none';
                tbody.style.display = 'table-row-group';

                dataToShow.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.className = row.status ? `status-${row.status.toLowerCase().replace(' ', '-')}` : '';
                    
                    const isManager = window.auth.userRole === 'manager';
                    const isPending = row.status === 'Pending';
                    
                    const vinReadonly = !isManager ? 'readonly style="color: #64748b;"' : '';
                    const dateReadonly = !isManager ? 'readonly style="color: #64748b;"' : '';
                    const statusDisabled = (!isManager && !isPending) ? 'disabled' : '';
                    
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td><input type="text" class="input-cell" value="${row.vin}" data-field="vin" data-key="${row.firebaseKey}" ${vinReadonly}></td>
                        <td><input type="text" class="input-cell" value="${row.serialNumber}" readonly style="font-family: monospace; color: #60a5fa; font-weight: 600;"></td>
                        <td><input type="date" class="input-cell" value="${row.entryDate}" data-field="entryDate" data-key="${row.firebaseKey}" ${dateReadonly}></td>
                        <td>
                            <select class="input-cell" data-field="status" data-key="${row.firebaseKey}" ${statusDisabled}>
                                <option value="Pending" ${row.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Inspected" ${row.status === 'Inspected' ? 'selected' : ''}>Inspected</option>
                                <option value="Not Found" ${row.status === 'Not Found' ? 'selected' : ''}>Not Found</option>
                            </select>
                        </td>
                        <td><input type="text" class="input-cell" value="${row.assignedTech}" readonly style="color: #94a3b8; font-size: 12px;"></td>
                        <td><input type="text" class="input-cell" value="${row.lastUpdate ? new Date(row.lastUpdate).toLocaleString() : ''}" readonly style="color: #94a3b8; font-size: 12px;"></td>
                        <td><input type="text" class="input-cell" value="${row.comments}" data-field="comments" data-key="${row.firebaseKey}" placeholder="Add comment..."></td>
                    `;
                    
                    tbody.appendChild(tr);
                });

                tbody.querySelectorAll('input, select').forEach(input => {
                    let oldValue = input.value;
                    input.addEventListener('focus', () => { oldValue = input.value; });
                    input.addEventListener('change', (e) => {
                        const key = e.target.dataset.key;
                        const field = e.target.dataset.field;
                        this.handleEdit(key, field, e.target.value, oldValue);
                    });
                });
            },

            async handleEdit(key, field, value, oldValue) {
                // Verificar autenticación
                if (!auth.currentUser) {
                    alert('Error: Not authenticated');
                    return;
                }
                
                if (window.auth.userRole === 'tech' && !['status', 'comments'].includes(field)) {
                    this.renderTable();
                    return;
                }

                const row = this.data.find(r => r.firebaseKey === key);
                if (!row) return;

                try {
                    const rowRef = ref(database, `vins/${key}`);
                    
                    if (field === 'vin') {
                        const vin = value.toString().trim().toUpperCase();
                        const serialMatch = vin.match(/(FL|R8|ZE|KR|2X|P9).*$/i);
                        const serialNumber = serialMatch ? serialMatch[0] : '';
                        
                        await update(rowRef, {
                            vin: vin,
                            serialNumber: serialNumber
                        });
                    } else if (field === 'status') {
                        let oldStatus = oldValue ? oldValue.toString().trim() : '';
                        let newStatus = value ? value.toString().trim() : '';

                        if (['in progress', 'not found'].includes(newStatus.toLowerCase())) {
                            newStatus = 'Not Found';
                        }

                        if (oldStatus === 'Pending' && newStatus !== 'Pending') {
                            await update(rowRef, {
                                status: newStatus,
                                assignedTech: window.auth.currentUser,
                                lastUpdate: new Date().toISOString()
                            });
                        } else if (oldStatus !== 'Pending' && window.auth.userRole === 'tech') {
                            return;
                        } else {
                            await update(rowRef, {
                                status: newStatus
                            });
                        }
                    } else if (field === 'comments' || field === 'entryDate') {
                        const updateData = { [field]: value };
                        if (field === 'comments') {
                            updateData.lastUpdate = new Date().toISOString();
                        }
                        await update(rowRef, updateData);
                    }
                } catch (error) {
                    console.error('Error updating:', error);
                    alert('Error updating: ' + error.message);
                    this.renderTable();
                }
            },

            async resetData() {
                if (window.auth.userRole !== 'manager') return;
                
                if (!auth.currentUser) {
                    alert('Error: Not authenticated');
                    return;
                }
                
                if (confirm('Delete all data? This will affect all connected devices.')) {
                    try {
                        await remove(vinsRef);
                        this.searchTerm = '';
                        document.getElementById('searchInput').value = '';
                    } catch (error) {
                        console.error('Error deleting:', error);
                        alert('Error deleting: ' + error.message);
                    }
                }
            },

            exportExcel() {
                if (this.data.length === 0) return alert('No data');
                const exportData = this.data.map(r => ({
                    'VIN': r.vin, 'Serial_Number': r.serialNumber, 'Entry_Date': r.entryDate,
                    'Status': r.status, 'Assigned_Tech': r.assignedTech,
                    'Last_Update': r.lastUpdate ? new Date(r.lastUpdate).toLocaleString() : '',
                    'Comments': r.comments
                }));
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                ws['!cols'] = [{wch: 20}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 25}, {wch: 20}, {wch: 30}];
                XLSX.utils.book_append_sheet(wb, ws, "VIN_Data");
                XLSX.writeFile(wb, `VIN_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            },

            exportPDF() {
                if (this.data.length === 0) return alert('No data');
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                doc.setFontSize(20);
                doc.text('VIN Tracker Report', 14, 20);
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()} | User: ${window.auth.currentUser}`, 14, 30);
                
                doc.autoTable({
                    head: [['VIN', 'Serial Number', 'Date', 'Status', 'Tech', 'Updated', 'Comments']],
                    body: this.data.map(r => [r.vin, r.serialNumber, r.entryDate, r.status, r.assignedTech, r.lastUpdate ? new Date(r.lastUpdate).toLocaleDateString() : '', r.comments]),
                    startY: 40,
                    styles: { fontSize: 9 },
                    headStyles: { fillColor: [99, 102, 241] }
                });
                doc.save(`VIN_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            },

            generateReport() {
                document.getElementById('reportModal').style.display = 'block';
                setTimeout(() => this.renderChart(), 100);
            },

            renderChart() {
                const grupos = {};
                this.data.forEach(row => {
                    let status = row.status || '';
                    if (['in progress', 'not found'].includes(status.toLowerCase())) status = 'Not Found';
                    if (!status) return;
                    if (!grupos[status]) grupos[status] = [];
                    grupos[status].push(row);
                });

                const ctx = document.getElementById('statusChart');
                if (!ctx) return;
                
                if (this.chart) this.chart.destroy();
                
                const labels = Object.keys(grupos);
                const data = labels.map(l => grupos[l].length);
                
                const colors = labels.map(s => {
                    if (s === 'Pending') return '#ef4444';
                    if (s === 'Inspected') return '#10b981';
                    if (s === 'Not Found') return '#f59e0b';
                    return '#6366f1';
                });
                
                this.chart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'bottom',
                                labels: { color: '#f8fafc', padding: 20 }
                            }
                        },
                        cutout: '60%'
                    }
                });
                
                this.renderReportList(grupos);
            },

            renderReportList(grupos) {
                const container = document.getElementById('reportContent');
                const orden = ["Inspected", "Pending", "Not Found"];
                const todos = orden.concat(Object.keys(grupos).filter(s => !orden.includes(s)));
                
                let html = '';
                todos.forEach(status => {
                    if (!grupos[status]) return;
                    const filas = grupos[status];
                    const color = status === 'Pending' ? '#ef4444' : status === 'Inspected' ? '#10b981' : '#f59e0b';
                    const textColor = status === 'Pending' ? '#f87171' : status === 'Inspected' ? '#34d399' : '#fbbf24';
                    
                    html += `
                        <div style="margin-bottom: 20px; padding: 16px; background: rgba(255,255,255,0.05); border-radius: 12px; border-left: 4px solid ${color};">
                            <div style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: ${textColor};">
                                ${status} (${filas.length})
                            </div>
                            <div style="font-size: 13px; color: #94a3b8;">
                                ${filas.map(f => `
                                    <div style="padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between;">
                                        <span><strong>${f.vin}</strong> → ${f.serialNumber}</span>
                                        ${f.assignedTech ? `<span style="color: #64748b;">${f.assignedTech}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html || '<p>No data</p>';
            },

            exportReportPDF() {
                if (this.data.length === 0) return alert('No data');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                doc.setFontSize(18);
                doc.text('Status Analytics Report', 14, 20);
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleString()} | User: ${window.auth.currentUser}`, 14, 30);
                
                const grupos = {};
                this.data.forEach(row => {
                    let status = row.status || '';
                    if (['in progress', 'not found'].includes(status.toLowerCase())) status = 'Not Found';
                    if (!status) return;
                    if (!grupos[status]) grupos[status] = [];
                    grupos[status].push(row);
                });

                const orden = ["Inspected", "Pending", "Not Found"];
                const todos = orden.concat(Object.keys(grupos).filter(s => !orden.includes(s)));
                
                let yPos = 45;
                
                todos.forEach((status) => {
                    if (!grupos[status]) return;
                    const items = grupos[status];
                    
                    if (yPos > 180) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    let fillColor = [99, 102, 241];
                    if (status === 'Pending') fillColor = [239, 68, 68];
                    if (status === 'Inspected') fillColor = [16, 185, 129];
                    if (status === 'Not Found') fillColor = [245, 158, 11];
                    
                    doc.setFontSize(14);
                    doc.setTextColor(fillColor[0], fillColor[1], fillColor[2]);
                    doc.text(`${status} (${items.length})`, 14, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 8;
                    
                    const tableData = items.map(r => [
                        r.vin, 
                        r.serialNumber, 
                        r.assignedTech || '-', 
                        r.lastUpdate ? new Date(r.lastUpdate).toLocaleDateString() : '-'
                    ]);
                    
                    doc.autoTable({
                        head: [['VIN', 'Serial Number', 'Technician', 'Last Update']],
                        body: tableData,
                        startY: yPos,
                        styles: { fontSize: 9, cellPadding: 2 },
                        headStyles: { fillColor: fillColor, textColor: 255 },
                        alternateRowStyles: { fillColor: [245, 245, 245] },
                        margin: { left: 14, right: 14 }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 15;
                });
                
                doc.save(`Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            },

            closeReport() {
                document.getElementById('reportModal').style.display = 'none';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            window.auth.init();
        });

        window.onclick = (e) => {
            if (e.target.classList.contains('modal') && e.target.id !== 'loginModal') {
                e.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
